<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>СИКН WEB</title>

<style>

#state-popup > div{
    margin-top:20px !important;
}

body{
    font-family:"Times New Roman", Times, serif;
    background:#f4f4f4;
    margin:0;
}

/* ===== РАЗМЕРЫ КОЛОНОК ===== */

#sikn-table th:nth-child(1), #sikn-table td:nth-child(1){ width:40px; }   /* № п/п */
#sikn-table th:nth-child(2), #sikn-table td:nth-child(2){ width:40px; }   /* № */
#sikn-table th:nth-child(3), #sikn-table td:nth-child(3){ width:230px; }  /* Наименование ПСП */
#sikn-table th:nth-child(4), #sikn-table td:nth-child(4){ width:200px; }  /* Владелец СИКН */
#sikn-table th:nth-child(5), #sikn-table td:nth-child(5){ width:200px; }  /* Грузоотправители */
#sikn-table th:nth-child(6), #sikn-table td:nth-child(6){ width:140px; }  /* Аттестованный диапазон */
#sikn-table th:nth-child(7), #sikn-table td:nth-child(7){ width:150px; }  /* Диапазон после поверки */
#sikn-table th:nth-child(8), #sikn-table td:nth-child(8){ width:200px; }  /* Тип соединения */
#sikn-table th:nth-child(9), #sikn-table td:nth-child(9){ width:200px; }  /* Передача к СДКУ */
#sikn-table th:nth-child(10), #sikn-table td:nth-child(10){ width:180px; } /* Способ сдачи нефти */
#sikn-table th:nth-child(11), #sikn-table td:nth-child(11){ width:300px; } /* Поверка */
#sikn-table th:nth-child(12), #sikn-table td:nth-child(12){ width:320px; } /* Текущее состояние СИКН */
#sikn-table th:nth-child(13), #sikn-table td:nth-child(13){ width:320px; } /* Метрологическая часть */

/* ===== CORPORATE TABLE DESIGN ===== */

table{
    border-collapse:separate;
    border-spacing:0;
    background:#ffffff;
    margin-left:auto;
    margin-right:auto;
    table-layout:fixed;
    width:95%;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
    box-sizing:border-box;
}

th{
    background:#f0f3f7;
    font-size:20px;
    font-weight:bold;
    padding:14px 10px;
    border-bottom:2px solid #d6dbe3;
    border-right:1px solid #c9ced6;
}

td{
    border-bottom:1px solid #d4d8df;
    border-right:1px solid #d1d5db;
    padding:12px 10px;
    vertical-align:middle;
    line-height:1.45;
    font-size:18px;
    text-align:center;
}

tr:hover td{
    background:#fafcff;
}

/* --- размеры колонок таблицы --- */


.readonly{
    background:#f8fafc;
    text-align:center;
    vertical-align:middle;
}

/* ===== UNIFIED POPUP DESIGN ===== */



.popup-title{
    font-size:26px;
    font-weight:bold;
    margin-bottom:18px;
}

.popup label{
    font-size:18px;
    font-weight:bold;
}

.popup input,
.popup select{
    width:100%;
    font-size:18px;
    padding:8px 10px;
    margin-top:4px;
    margin-bottom:12px;
    border:1px solid #444;
    background:#fff;
}

.popup input:focus,
.popup select:focus{
    outline:none;
    border-color:#000;
    background:#fffbe6;
}

.popup-actions{
    margin-top:20px;
    text-align:right;
}

.popup button{
    font-size:18px;
    padding:8px 18px;
    border:1px solid #333;
    background:#f2f2f2;
    cursor:pointer;
}

.popup button:hover{
    background:#e3e3e3;
}

#range-popup{
    font-size:18px;
}

#range-popup input,
#range-popup select{
    font-size:18px;
    padding:6px;
    height:32px;
}

#verify-popup{
    font-size:24px;
}

#verify-popup input{
    font-size:24px;
    padding:12px;
    height:54px;
}

#verify-popup select{
    font-size:24px !important;
    height:54px !important;
    padding:12px !important;
}


#state-popup input,
#state-popup select{
    font-size:26px !important;
    height:60px !important;
    padding:14px !important;
    border:1px solid #cfd6e0 !important;
    border-radius:4px !important;
    background:#f8fafc !important;
}



#state-popup button:hover{
    background:#e0e0e0;
}

#verify-popup button{
    font-size:20px;
    padding:10px 18px;
}

#range-popup button{
    font-size:18px;
    padding:6px 14px;
}

/* ===== BIG DATE PICKER (для всех popup) ===== */



/* при фокусе чуть светлее */
.popup input.custom-date:focus{
    background:#fffbe6;
    border:2px solid #000;
}

/* ===== NORMAL DATE INPUT ===== */

.popup input.custom-date{
    width:100%;
    height:46px;
    font-size:20px;
    padding:8px 10px;
    box-sizing:border-box;
}


/* ===== BIG METROLOGY POPUP ===== */

#metrology-popup input{
    font-size:24px !important;
    height:54px !important;
    padding:12px !important;
    border:2px solid #333 !important;
}

#metrology-popup label{
    font-size:24px !important;
    font-weight:bold !important;
}

#metrology-popup button{
    font-size:24px !important;
    padding:12px 28px !important;
    border:2px solid #333 !important;
}

/* ===== TOGGLE TECH COLUMNS ===== */

.hide-tech #sikn-table th:nth-child(8),
.hide-tech #sikn-table td:nth-child(8),
.hide-tech #sikn-table th:nth-child(9),
.hide-tech #sikn-table td:nth-child(9){
    display:none;
}

.blue-row td{
    background:#4a7bd1 !important;
    color:#ffffff !important;
}

.date-red{
    color:#ff0000 !important;
    font-weight:bold;
}

.date-orange{
    color:#ff7a00 !important;
    font-weight:bold;
}

/* BIGGER DATE INPUT */

.popup input.custom-date{
    font-size:22px;
    height:54px;
}


.popup input.custom-date::-webkit-datetime-edit{
    font-size:22px;
}

.popup input.custom-date{
    text-transform:uppercase;
}

/* ===== CLEAN MODERN POPUP ===== */

.popup{
    display:none;
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:640px;
    background:#ffffff;
    border-radius:8px;
    box-shadow:0 20px 60px rgba(0,0,0,0.25);
    padding:28px 32px;
    box-sizing:border-box;
    font-size:15px;
    border:none;
}

.popup-title{
    font-size:18px;
    font-weight:600;
    margin-bottom:18px;
    color:#1f4f8a;
}

.popup label{
    font-size:22px;
    font-weight:600;
    color:#333;
}

.popup input,
.popup select{
    width:100%;
    height:54px;
    font-size:24px;
    padding:12px 14px;
    border:1px solid #cfd6e0;
    border-radius:4px;
    background:#f8fafc;
    box-sizing:border-box;
    margin-top:4px;
    margin-bottom:14px;
}

.popup input:focus,
.popup select:focus{
    outline:none;
    border-color:#3b82f6;
    background:#ffffff;
    box-shadow:0 0 0 2px rgba(59,130,246,0.15);
}

.popup-actions{
    margin-top:10px;
    text-align:right;
}

.popup button{
    font-size:14px;
    padding:8px 18px;
    border-radius:4px;
    border:1px solid #cfd6e0;
    background:#e5e7eb;
    cursor:pointer;
    min-width:110px;
}

.popup button:first-child{
    background:#2f6fe4;
    color:#fff;
    border:1px solid #2f6fe4;
}

.popup button:first-child:hover{
    background:#245ac0;
}

.popup button:last-child:hover{
    background:#d9dce1;
}


</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>

.flatpickr-calendar{
    transform: scale(1.1) !important;
    transform-origin: top left !important;
}

.flatpickr-day{
    font-size:22px !important;
}

.flatpickr-weekday{
    font-size:20px !important;
}

.flatpickr-current-month{
    font-size:22px !important;
}

.flatpickr-monthDropdown-months{
    font-size:22px !important;
}

.numInputWrapper input{
    font-size:22px !important;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script>


</script>



</head>
<body>

<button id="logout-btn" style="
position:fixed;
top:15px;
right:20px;
z-index:10000;
font-size:14px;
padding:6px 14px;
border-radius:6px;
border:1px solid #aa0000;
background:#cc0000;
color:white;
cursor:pointer;
box-shadow:0 4px 12px rgba(0,0,0,0.2);
">
Выйти
</button>

<div id="login-block" style="
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:#f4f4f4;
display:flex;
justify-content:center;
align-items:center;
z-index:9999;
">

<div style="
background:white;
padding:40px;
border-radius:10px;
box-shadow:0 20px 60px rgba(0,0,0,0.2);
width:400px;
">

<h2 style="text-align:center;">Вход в систему</h2>

<input id="login-username" placeholder="Логин"
style="width:100%;margin-bottom:15px;font-size:18px;padding:10px;">

<input id="login-password" type="password" placeholder="Пароль"
style="width:100%;margin-bottom:20px;font-size:18px;padding:10px;">

<button id="login-btn" style="
width:100%;
padding:12px;
font-size:18px;
background:#2f6fe4;
color:white;
border:none;
cursor:pointer;
">
Войти
</button>

<div id="login-error" style="color:red;margin-top:15px;text-align:center;"></div>

</div>
</div>

<div style="
margin:40px auto;
margin:0 auto;
background:#ffffff;
padding:30px;
border-radius:10px;
box-shadow:0 20px 60px rgba(0,0,0,0.08);
">

<h2 style="font-size:32px; margin-bottom:10px;">
Текущее состояние СИКН
</h2>



<button id="export-excel" style="
margin-bottom:20px;
font-size:18px;
padding:10px 22px;
border-radius:6px;
border:1px solid #2f5fbf;
background:#2f6fe4;
color:white;
cursor:pointer;
box-shadow:0 6px 14px rgba(0,0,0,0.12);
">
Выгрузить в Excel
</button>

<button id="toggle-tech-cols" style="
margin-bottom:20px;
margin-left:10px;
font-size:18px;
padding:10px 22px;
border-radius:6px;
border:1px solid #444;
background:#f4f6f9;
cursor:pointer;
">
Показать тех. столбцы
</button>

<table id="sikn-table">
<tr>
<th>№ п/п</th>
<th>№</th>
<th>Наименование ПСП</th>
<th>Владелец СИКН</th>
<th>Наименование грузоотправителей и грузополучателей сдающих/принимающих нефть</th>
<th>Аттестованный диапазон СИКН</th>
<th>Диапазон после последней поверки СИКН</th>
<th>Тип соединения</th>
<th>По передаче данных к СДКУ</th>
<th>Текущий способ сдачи нефти</th>
<th>Поверка</th>
<th>Текущее состояние СИКН</th>
<th>Текущее состояние по метрологической части</th>
</tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Мангистауское нефтепроводное управление
</td>
</tr>

<tr data-row="1"><td class="readonly">1</td><td class="readonly">1</td><td class="readonly">Отводящий трубопровод 0/250км - Битумный завод</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "Каражанбасмунай"</td><td>350-1400 т/ч</td><td class="range-cell"></td><td class="readonly">по схеме 2 ТТ на подключение СИКН с использованием конверторов</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">2</td><td class="readonly">2</td><td class="readonly">ГНПС "Каламкас"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "МангистауМунайгаз"</td><td>270-670 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">3</td><td class="readonly">3</td><td class="readonly">НПС "Каражанбас"</td><td class="readonly">АО "Каражанбасмунай"</td><td class="readonly">АО "Каражанбасмунай"</td><td>150-1000 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">4</td><td class="readonly">4</td><td class="readonly">Подкачка, 22 км МН "Каламкас-Каражанбас-Актау" (ПСП Арман)</td><td class="readonly">ТОО СП "Арман"</td><td class="readonly">ТОО СП "Арман"</td><td>25-85 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">5</td><td class="readonly">5</td><td class="readonly">Подкачка, 22 км МН "Каламкас-Каражанбас-Актау" (ПСП Бузачи Нефть)</td><td class="readonly">ТОО "Бузачи Нефть"</td><td class="readonly">ТОО "Бузачи Нефть"</td><td>25-80 т/ч</td><td></td><td class="readonly"></td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">6</td><td class="readonly">6</td><td class="readonly">НПС "Северные Бузачи"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">СНПС Интернэшнл Бузачи, НельсонПетролеум</td><td>80-277 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">7</td><td class="readonly">7</td><td class="readonly">Подкачка, 200 км МН "Каламкас-Каражанбас-Актау" (ПСП Дунга)</td><td class="readonly">DUNGA OPERATING GMBH</td><td class="readonly">DUNGA OPERATING GMBH</td><td>75-140 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">8</td><td class="readonly">8</td><td class="readonly">Подкачка, 195 км МН "Узень-Атырау-Самара" (ПСП Каракудук)</td><td class="readonly">ТОО "Каракудукмунай"</td><td class="readonly">ТОО "Каракудукмунай"</td><td>30-200 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">9</td><td class="readonly">9</td><td class="readonly">Подкачка, 195 км МН "Узень-Атырау-Самара" (ПСП КОМ-Мунай)</td><td class="readonly">ТОО "Ком-Мунай"</td><td class="readonly">ТОО "Ком-Мунай"</td><td>27-56 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">10</td><td class="readonly">10</td><td class="readonly">Подкачка, 214 км МН "Узень-Атырау-Самара"</td><td class="readonly">ТОО "Кен-Сары"</td><td class="readonly">ТОО "Кен-Сары"</td><td>40-150 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">11</td><td class="readonly">11</td><td class="readonly">НПС "Жетыбай"</td><td class="readonly">АО "Мангыстаумунайгаз"</td><td class="readonly">АО "Мангыстаумунайгаз"</td><td>70-660 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">12</td><td class="readonly">12</td><td class="readonly">ГНПС "Узень"</td><td class="readonly">АО "ОзенМунайГаз"</td><td class="readonly">АО "ОзенМунайГаз"</td><td>203-1950 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">13</td><td class="readonly">13</td><td class="readonly">ГНПС "Узень"</td><td class="readonly">ТОО "TENGE OIL & GAS"</td><td class="readonly">ТОО "TENGE OIL & GAS"</td><td>20-80 т/ч</td><td></td><td class="readonly">по схеме 2 ТТ на подключение СИКН с использованием конверторов</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">14</td><td class="readonly">14</td><td class="readonly">Подкачка, 44 км МН "Узень-Жетыбай-Актау" (ПСП Тасбулат)</td><td class="readonly">ТОО "Тасболат Ойл Корпорэшн"</td><td class="readonly">ТОО "Тасболат Ойл Корпорэшн"</td><td>34-64 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">15</td><td class="readonly">15</td><td class="readonly">Подкачка на 91 км МН "Узень-Жетыбай-Актау"</td><td class="readonly">ТОО "Oil Preparation Terminal"</td><td class="readonly">ТОО "Ансаган Петролеум", ТОО "Актау Транзит", ТОО "CASPIOILGAS"</td><td>40-90 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">16</td><td class="readonly">16</td><td class="readonly">СИКН ТОО "Caspian Oil Trans"</td><td class="readonly">ТОО "Caspian Oil Trans"</td><td class="readonly">ТОО "Caspian Oil Trans"</td><td>40-100 т/ч</td><td></td><td class="readonly">по схеме 2 ТТ на подключение СИКН с использованием конверторов</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>


<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Кульсаринское нефтепроводное управление
</td>
</tr>


<tr><td class="readonly">17</td><td class="readonly">1</td><td class="readonly">НПС "Прорва"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "Эмбамунайгаз"</td><td>150-380 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">18</td><td class="readonly">2</td><td class="readonly">НПС-3</td><td class="readonly">АО "Эмбамунайгаз"</td><td class="readonly">АО "Эмбамунайгаз" НГДУ "Кайнармунайгаз", АО "Анако"</td><td>80-200 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">19</td><td class="readonly">3</td><td class="readonly">Подкачка 589 км МН "Узень - Атырау - Самара" (ПСП Карсак)</td><td class="readonly">АО "Эмбамунайгаз"</td><td class="readonly">АО "Эмбамунайгаз"</td><td>30-200 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">20</td><td class="readonly">4</td><td class="readonly">Подкачка 433,3 км МН "Узень - Атырау - Самара" (СПН Опорный)</td><td class="readonly">ТСБ ТОО "Nobilis Corp"</td><td class="readonly">ТСБ ТОО "Nobilis Corp"</td><td>50-180 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">21</td><td class="readonly">5</td><td class="readonly">Подкачка 433,3 км н/п "Узень - Атырау - Самара" (СПН Опорный)</td><td class="readonly">ТОО "Meerbusch"</td><td class="readonly">ТОО "Meerbusch"</td><td>30-105 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">22</td><td class="readonly">6</td><td class="readonly">СПН "Опорный" подкачка 433,3 км МН "Узень - Атырау - Самара"</td><td class="readonly">ТОО "КазахТуркМунай"</td><td class="readonly">ТОО "КазахТуркМунай"</td><td>112-285 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">23</td><td class="readonly">7</td><td class="readonly">НПС "Каратон"</td><td class="readonly">АО "Матен Петролеум"</td><td class="readonly">АО "Матен Петролиум", АО "Эмбамунайгаз"</td><td>110-400 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">24</td><td class="readonly">8</td><td class="readonly">Подкачка 567 км МН "Узень - Атырау - Самара" (ПСП КаспийНефть)</td><td class="readonly">АО "Каспий Нефть"</td><td class="readonly">АО "Каспий Нефть"</td><td>60-250 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">25</td><td class="readonly">9</td><td class="readonly">Подкачка 589 км н/п "Узень - Атырау - Самара" (ПСП Карсак - Алтиес)</td><td class="readonly">ТОО "AEKK munai"</td><td class="readonly">ТОО "AEKK munai", ТОО "Гюрал", ТОО "Манаш Петролеум"</td><td>5-80 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">26</td><td class="readonly">10</td><td class="readonly">ЦППН "Прорва"</td><td class="readonly">НГДУ "Жылыоймунайгаз"</td><td class="readonly">НГДУ "Жылыоймунайгаз"</td><td>70-190 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Атырауское нефтепроводное управление
</td>
</tr>

<tr><td class="readonly">27</td><td class="readonly">1</td><td class="readonly">НПС "Мартыши"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">ТОО "Светланд Ойл", ТОО "Тобеарал Ойл", АО "Эмбамунайгаз", ТОО "AB PETROLEUM CAPITAL"</td><td>120-320 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">28</td><td class="readonly">2</td><td class="readonly">НПС "Мартыши"</td><td class="readonly">ТОО "Потенциал Ойл"</td><td class="readonly">ТОО "Потенциал Ойл"</td><td>50-90 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">29</td><td class="readonly">3</td><td class="readonly">НПС "Макат"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "Эмбамунайгаз", ТОО "Самек Интернэшнл"</td><td>30-158 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">30</td><td class="readonly">4</td><td class="readonly">НПС им. Т. Касымова (КТК-К 22 - РК - А006)</td><td class="readonly">АО "КТК-К"</td><td class="readonly">Кумкольская нефть</td><td>3-1000 м3/ч</td><td></td><td class="readonly">по схеме 1 ТТ на подключение СИКН через контроллер</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">31</td><td class="readonly">5</td><td class="readonly">НПС им. Т. Касымова (КТК-К 22 - РК - А005)</td><td class="readonly">АО "КТК-К"</td><td class="readonly">Западно-Казахстанская смесь</td><td>3-1000 м3/ч</td><td></td><td class="readonly">по схеме 1 ТТ на подключение СИКН через контроллер</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">32</td><td class="readonly">6</td><td class="readonly">НПС им. Т. Касымова (КТК-К 22 - РК - А007)</td><td class="readonly">АО "КТК-К"</td><td class="readonly">Мартыши</td><td>3-1000 м3/ч</td><td></td><td class="readonly">по схеме 1 ТТ на подключение СИКН через контроллер</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">33</td><td class="readonly">7</td><td class="readonly">НПС им. Т. Касымова (КТК-LO203 - РК - А002)</td><td class="readonly">АО "КТК-К"</td><td class="readonly">ТОО "Тенгизшевройл"</td><td>3-1000 м3/ч</td><td></td><td class="readonly">по схеме 1 ТТ на подключение СИКН через контроллер</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">34</td><td class="readonly">8</td><td class="readonly">АНПЗ МН НПС 663 км - АНПЗ (Мангышлак)</td><td class="readonly">ТОО "АНПЗ"</td><td class="readonly">ТОО "АНПЗ"</td><td>150-900 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">35</td><td class="readonly">9</td><td class="readonly">НПС им. Т. Касымова (NCOC СИКН "C3-160-JM-002")</td><td class="readonly">NCOC</td><td class="readonly">Кашаганская нефть</td><td>250-3974,68 м<sup>3</sup>/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">36</td><td class="readonly">10</td><td class="readonly">НПС им. Н. Шманова ТОО "СЗТК МунайТас"</td><td class="readonly">ТОО "МунайТас"</td><td class="readonly">ТОО "МунайТас"</td><td>120-1260 т/ч</td><td></td><td class="readonly">по схеме 2 ТТ на подключение СИКН с использованием конверторов</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
ЛПДС «Уральск»
</td>
</tr>

<tr><td class="readonly">37</td><td class="readonly">11</td><td class="readonly">НПС "Б. Чаган"</td><td class="readonly">АОЗТ «Карачаганак Петролеум Оперейтинг Б.В.»</td><td class="readonly">АОЗТ «Карачаганак Петролеум Оперейтинг Б.В.»</td><td>90-900 м3/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">38</td><td class="readonly">12</td><td class="readonly">ПСП "Жаикмунай"</td><td class="readonly">ТОО "Жаикмунай"</td><td class="readonly">ТОО "Жаикмунай"</td><td>35-110 т/ч</td><td></td><td class="readonly">по схеме 2 ТТ на подключение СИКН с использованием конверторов</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">39</td><td class="readonly">13</td><td class="readonly">СИКН и РСУ "ПСП на 1235 км" (СИКН №729)</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "КазТрансОйл"</td><td>500-2400 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">40</td><td class="readonly">14</td><td class="readonly">СИКН №719 ПСП "ССН Самара"</td><td class="readonly">ПАО "Транснефть"</td><td class="readonly">АО "Транснефть-Приволга"</td><td>565-3040 м3/ч</td><td></td><td class="readonly"></td><td>Не подключен</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Актюбинское нефтепроводное управление
</td>
</tr>

<tr><td class="readonly">41</td><td class="readonly">1</td><td class="readonly">ГНПС "Кенкияк-Фишер"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "СНПС-Актобемунайгаз"</td><td>80-520 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">42</td><td class="readonly">2</td><td class="readonly">ГНПС "Кенкияк" (ТОО "ККТ")</td><td class="readonly">ТОО "ККТ"</td><td class="readonly">Нефть Актюбинских месторождений</td><td>100-1800 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">43</td><td class="readonly">3</td><td class="readonly">ГНПС "Кенкияк" (АО "СЗТК МунайТас")</td><td class="readonly">АО "СЗТК МунайТас"</td><td class="readonly">АО "ТД КазМунайГаз", ТОО "КазахТуркМунай", АО "СНПС-Актобемунайгаз", ТОО "Казахойл Актобе"</td><td>141-1110 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">44</td><td class="readonly">4</td><td class="readonly">КПОУ "Жанажол" 0 км МН "Жанажол-Кенкияк"</td><td class="readonly">АО "СНПС-Актобемунайгаз"</td><td class="readonly">АО "СНПС-Актобемунайгаз"</td><td>200-1360 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">45</td><td class="readonly">5</td><td class="readonly">ГНПС "Кенкияк" ПСП Кенкияк-АПИ</td><td class="readonly">Алтиес Петролеум Интернэшнл Б.В.</td><td class="readonly">Алтиес Петролеум Интернэшнл Б.В.</td><td>26,5-150 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">46</td><td class="readonly">6</td><td class="readonly">ПСП 45 км подкачка на 45 км МН "Жанажол - Кенкияк" (м/р Кокжиде)</td><td class="readonly">АО "КМК Мунай"</td><td class="readonly">АО "КМК Мунай"</td><td>50-130 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">47</td><td class="readonly">7</td><td class="readonly">ГНПС "Алибекмола" ПСП ТОО "Казахойл Актобе"</td><td class="readonly">ТОО "Казахойл Актобе"</td><td class="readonly">ТОО "Казахойл Актобе"</td><td>40,9-300 т/ч</td><td></td><td class="readonly">по схеме 2 ТТ на подключение СИКН с использованием конверторов</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">48</td><td class="readonly">8</td><td class="readonly">ГНПС "Алибекмола" ПСП АО "Каспий нефть ТМЕ"</td><td class="readonly">АО "Каспий нефть ТМЕ"</td><td class="readonly">АО "Каспий нефть ТМЕ"</td><td>60-200 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Павлодарское нефтепроводное управление
</td>
</tr>

<tr><td class="readonly">49</td><td class="readonly">1</td><td class="readonly">ГНПС "Павлодар" МН "Павлодар-ПНХЗ"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">ТОО "ПНХЗ"</td><td>100-1800 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Шымкентское нефтепроводное управление
</td>
</tr>

<tr><td class="readonly">50</td><td class="readonly">1</td><td class="readonly">ПСП "Шымкент" МН "Павлодар-Шымкент"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">ТОО "ПКОП"</td><td>250-1100 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Карагандинское нефтепроводное управление
</td>
</tr>

<tr><td class="readonly">51</td><td class="readonly">1</td><td class="readonly">ГНПС "Атасу" МН "Атасу - Алашанькоу"</td><td class="readonly">АО "КазТрансОйл"</td><td class="readonly">АО "Тургай Петролеум", АО "СНПС-АктобеМунайгаз", АО "ПККР", ТОО СП "Казгермунай", АО "СНПС Ай Дан Мунай", ТОО "Куатамлонмунай", ТОО "СаутсОйл", АО "НК КОР", АО "Каспий нефть ТМЕ", АО "КМК Мунай"</td><td>100-2200 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>

<tr>
<td colspan="13" class="readonly" style="font-weight:bold; text-align:center; font-size:22px; background:#e9e9e9;">
Жезказганское нефтепроводное управление
</td>
</tr>

<tr><td class="readonly">52</td><td class="readonly">1</td><td class="readonly">ЦППН АО "ПетроКазахстан Кумколь Ресорсиз" Н/П "СИКН-2 - Кумколь"</td><td class="readonly">АО "ПетроКазахстан Кумколь Ресорсиз"</td><td class="readonly">АО "ПетроКазахстан Кумколь Ресорсиз", ТОО "Кольжан", ПКВИ, ТОО "КазПетролГруп"</td><td>15-1200 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">53</td><td class="readonly">2</td><td class="readonly">ПСН "Кумколь" Н/П "Коныс-Кумколь"</td><td class="readonly">ТОО СП "КуатАмлонМунай"</td><td class="readonly">ТОО СП "КуатАмлонМунай"</td><td>20-136 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">54</td><td class="readonly">3</td><td class="readonly">ПСП "Ащисай" Н/П "СИКН КОР - Кумколь"</td><td class="readonly">АО "Нефтяная компания КОР"</td><td class="readonly">АО "Нефтяная компания КОР", ТОО "Кумколь Транс Сервис", ТОО "КазПетролГруп"</td><td>30-100 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">55</td><td class="readonly">4</td><td class="readonly">Н/П "Кенкияк-Кумколь"</td><td class="readonly">ТОО "ККТ"</td><td class="readonly">АО СНПС "Актобемунайгаз", ТОО "Саутс Ойл", ТОО "Казахойл Актобе"</td><td>100-1800 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">56</td><td class="readonly">5</td><td class="readonly">УПН АО "СНПС-АйДанМунай" Н/П "Арыское-Кумколь"</td><td class="readonly">АО "СНПС АйДанМунай"</td><td class="readonly">АО "СНПС АйДанМунай"</td><td>40-110 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">57</td><td class="readonly">6</td><td class="readonly">НП "Тургай Петролеум"</td><td class="readonly">АО "Тургай Петролеум"</td><td class="readonly">АО "Тургай Петролеум"</td><td>20-80 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">58</td><td class="readonly">7</td><td class="readonly">ПСП "Акшабулак" Н/П "Акшабулак-Кумколь"</td><td class="readonly">ТОО СП "КазГерМунай"</td><td class="readonly">ТОО СП "КазГерМунай"</td><td>80-250 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>
<tr><td class="readonly">59</td><td class="readonly">8</td><td class="readonly">СИКН ТОО СП "КазГерМунай", на входе ГНПС "Кумколь"</td><td class="readonly">ТОО СП "КазГерМунай"</td><td class="readonly">ТОО СП "КазГерМунай"</td><td>70-370 т/ч</td><td></td><td class="readonly">через шлюзовый сервер по протоколу OPC DA</td><td>Выведен на уровне ГДУ</td><td></td><td></td><td></td><td></td></tr>


</table>
</div>



<div id="range-popup" class="popup">

<div class="popup-title">Аттестованный диапазон СИКН</div>

<div>
<label>Аттестованный диапазон СИКН:</label>
<input type="text" id="att-range-input">
</div>

<div class="popup-actions">
<button id="range-save">Сохранить</button>
<button id="range-cancel">Отмена</button>
</div>

</div><div id="scheme-popup" class="popup">

<div style="margin-bottom:15px; font-weight:bold;">Текущий способ сдачи нефти</div>

<select id="scheme-select" style="width:100%; font-size:18px; padding:6px;">
<option value="Основная схема измерения с применением СИКН">Основная схема измерения с применением СИКН</option>
<option value="Резервная схема измерения с применением РВС">Резервная схема измерения с применением РВС</option>
<option value="-">-</option>
</select>

<div class="popup-actions">
<button type="button" id="scheme-save">Сохранить</button>
<button type="button" id="scheme-cancel">Отмена</button>
</div>

</div>



<div id="verify-popup" class="popup">

<div class="popup-title">Поверка</div>

<div>
<label>Дата поверки СИКН:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="verify-sikn" style="width:100%;">

<select id="verify-sikn-int" style="width:100%;">
<option value="">Межповерочный интервал</option>
<option value="1">1 год</option>
<option value="2">2 года</option>
<option value="3">3 года</option>
<option value="4">4 года</option>
<option value="5">5 лет</option>
</select>
</div>

<div id="verify-il-container" style="margin-top:10px;"></div>

<div style="margin-top:10px;">
<label>Дата поверки ПП:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="verify-pp" style="width:100%;">

<select id="verify-pp-int" style="width:100%;">
<option value="">Межповерочный интервал</option>
<option value="1">1 год</option>
<option value="2">2 года</option>
<option value="3">3 года</option>
<option value="4">4 года</option>
<option value="5">5 лет</option>
</select>
</div>

<div style="margin-top:10px;">
<label>Дата поверки ТПУ:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="verify-tpu" style="width:100%;">

<select id="verify-tpu-int" style="width:100%;">
<option value="">Межповерочный интервал</option>
<option value="1">1 год</option>
<option value="2">2 года</option>
<option value="3">3 года</option>
<option value="4">4 года</option>
<option value="5">5 лет</option>
</select>
</div>

<div style="margin-top:10px;">
<label>Дата поверки компьютеров расхода:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="verify-comp" style="width:100%;">

<select id="verify-comp-int" style="width:100%;">
<option value="">Межповерочный интервал</option>
<option value="1">1 год</option>
<option value="2">2 года</option>
<option value="3">3 года</option>
<option value="4">4 года</option>
<option value="5">5 лет</option>
</select>

</div>

<div class="popup-actions">
<button type="button" id="verify-save">Сохранить</button>
<button type="button" id="verify-cancel">Отмена</button>
</div>

<div style="margin-top:10px;">

</div>

</div>

<div id="state-popup" class="popup">

<div style="font-weight:bold; margin-bottom:15px;">Текущее состояние СИКН</div>

<div>
<label>Статус:</label><br>
<select id="state-status" style="width:100%; font-size:18px; padding:6px;">
<option value="in">СИКН в учетных операциях</option>
<option value="out">СИКН выведена из учетных операций</option>
</select>
</div>

<div style="margin-top:10px;">
<label id="state-date-label">Дата ввода:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="state-date" style="width:100%;">
</div>

<div id="state-reason-block" style="margin-top:10px; display:none;">
<label>Причина вывода:</label><br>
<input type="text" id="state-reason" style="width:100%;">
</div>

<div style="margin-top:10px;">
<label>Дата проведения КМХ:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="state-kmx-done" style="width:100%;">
</div>

<div style="margin-top:10px;">
<label>Планируемая дата КМХ:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="state-kmx-plan" style="width:100%;">
</div>

<div class="popup-actions">
<button id="state-save">Сохранить</button>
<button id="state-cancel">Отмена</button>
</div>

</div>

<div id="range-after-popup" class="popup">

<div class="popup-title">Диапазон после последней поверки СИКН</div>

<div>
<label>Диапазон СИКН:</label>
<input type="text" id="after-sikn">
</div>

<div>
<label>Количество ИЛ:</label>
<select id="after-il-count">
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
</select>
</div>

<div id="after-il-container"></div>

<div class="popup-actions">
<button id="after-save">Сохранить</button>
<button id="after-cancel">Отмена</button>
</div>

</div>
<div id="metrology-popup" class="popup">

<div class="popup-title">Номер сертификата о метрологической аттестации</div>
<input type="text" id="met-cert" style="width:100%;">


<div>
<label>Регистрационный номер в реестре ГСИ РК:</label><br>
<input type="text" id="met-reg" style="width:100%;">
</div>

<div>
<label>Дата:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="met-date" style="width:100%;">
</div>

<div>
<label>Срок действия МВИ:</label><br>
<input type="text" class="custom-date" autocomplete="off" id="met-expire" style="width:100%;">
</div>

<div class="popup-actions">
<button id="met-save">Сохранить</button>
<button id="met-cancel">Отмена</button>
</div>

</div>





<script>



fetch("/load_cells")
.then(r => r.json())
.then(data => {

    data.forEach(c => {

        const row = document.getElementById("sikn-table").rows[c.row];
        if(!row) return;

        const td = row.cells[c.col];
        if(!td) return;

        td.innerHTML = c.value;

        if(c.col === 11 && c.value && c.value.includes("выведена")){
    row.classList.add("blue-row");
}

if(c.col === 10 && c.value){
    checkVerifyColors(td);
}

    });

})
.catch(err => {
    console.error("Ошибка загрузки данных:", err);
});


let activeCell = null;
let activeSchemeCell = null;
let activeVerifyCell = null;
let activeStateCell = null;
let activeMetCell = null;

// ===== RANGE COLUMNS (чистый блок) =====
document.querySelectorAll("#sikn-table tr").forEach((row,i)=>{

    if(i===0) return;


    const td6 = row.children[5];

if(td6){
    td6.style.cursor="pointer";
    td6.onclick=function(){
        activeCell = td6;
        document.getElementById("att-range-input").value = td6.innerText;
        document.getElementById("range-popup").style.display="block";
    };
}
       
});

// ===== RANGE AFTER COLUMN (7) =====
let activeAfterCell = null;

document.querySelectorAll("#sikn-table tr").forEach((row,i)=>{

    if(i===0) return;

    const td7 = row.querySelector("td:nth-child(7)");

    if(!td7) return;

    td7.style.cursor="pointer";

    td7.onclick=function(){
        activeAfterCell = td7;
        document.getElementById("range-after-popup").style.display="block";
    };

});



// ===== RANGE POPUP =====
document.getElementById("range-cancel").onclick=function(){
    document.getElementById("range-popup").style.display="none";
};

// ===== SCHEME COLUMN (10) =====
document.querySelectorAll("#sikn-table tr").forEach(function(row,i){

    if(i===0) return;

    const cells = row.querySelectorAll("td");

    if(cells.length < 10) return;

    const td = cells[9]; // 10 столбец

    td.style.cursor = "pointer";

    td.addEventListener("click", function(){

        activeSchemeCell = td;

        const current = td.innerText.trim();

        const select = document.getElementById("scheme-select");

        if(current){
            select.value = current;
        }else{
            select.selectedIndex = 0;
        }

        document.getElementById("scheme-popup").style.display = "block";

    });

});



document.getElementById("range-save").onclick=function(){

    const val = document.getElementById("att-range-input").value;

    if(activeCell){
        activeCell.innerHTML = val;

        fetch("/save_cell",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                row: activeCell.parentElement.rowIndex,
                col: activeCell.cellIndex,
                value: val
            })
        });
    }

    document.getElementById("range-popup").style.display="none";
};



  

// ===== SCHEME POPUP =====
document.getElementById("scheme-cancel").onclick=function(){
    document.getElementById("scheme-popup").style.display="none";
};

document.getElementById("scheme-save").onclick=function(){

    const val = document.getElementById("scheme-select").value;

    if(activeSchemeCell){
        activeSchemeCell.innerHTML = val;

fetch("/save_cell",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
        row: activeSchemeCell.parentElement.rowIndex,
        col: activeSchemeCell.cellIndex,
        value: val
    })
});
    }

    document.getElementById("scheme-popup").style.display="none";
};

// ===== SCHEME COLUMN (10) =====
document.querySelectorAll("#sikn-table tr").forEach((row,i)=>{

    if(i===0) return;

    const td = row.children[9]; // 10 столбец

    if(!td) return;

    td.style.cursor="pointer";

    td.onclick = function(){

        activeSchemeCell = td;

        const current = td.innerText.trim();

        if(current){
            document.getElementById("scheme-select").value = current;
        }else{
            document.getElementById("scheme-select").selectedIndex = 0;
        }

        document.getElementById("scheme-popup").style.display="block";
    };

});

// ===== VERIFY COLUMN (11) =====
document.querySelectorAll("#sikn-table tr").forEach(function(row,i){

    if(i===0) return;

    const td = row.querySelector("td:nth-child(11)");
    if(!td) return;

    td.onclick = function(){

        activeVerifyCell = td;

        const afterCell = row.querySelector("td:nth-child(7)");
        const box = document.getElementById("verify-il-container");
        box.innerHTML="";

        if(afterCell){

            const html = afterCell.innerHTML;
            const matches = html.match(/Диапазон ИЛ\s*\d+/g);

            if(matches){
                matches.forEach(function(name){

                    const num = name.replace("Диапазон ИЛ","");

                    const div = document.createElement("div");
                    div.style.marginTop="10px";
                    div.innerHTML =
                        '<label>Дата поверки ПР ИЛ'+num+':</label><br>'+
                        '<input type="text" class="custom-date verify-il" autocomplete="off" style="width:100%;">';

                    box.appendChild(div);
                });
            }
        }

        document.getElementById("verify-popup").style.display="block";

        setTimeout(function(){
            document.querySelectorAll(".verify-il").forEach(function(input){
                flatpickr(input,{
                    locale:"ru",
                    dateFormat:"d.m.Y",
                    allowInput:true,
                    disableMobile:true
                });
            });
        },100);

    };

});


document.getElementById("verify-cancel").onclick=function(){
    document.getElementById("verify-popup").style.display="none";
};

document.getElementById("verify-save").onclick=function(){

    function fmt(d){
        if(!d) return "";
        const p=d.split(".");
        return p[0]+"."+p[1]+"."+p[2];
    }

    let text="";

    const sikn = document.getElementById("verify-sikn").value;

const siknInt = document.getElementById("verify-sikn-int").value;

   text+="Поверка СИКН выполнена - "+fmt(sikn)+" г. ("+siknInt+" г.)<br>";

    const ils = document.querySelectorAll(".verify-il");
    ils.forEach((el,i)=>{
        if(el.value){
            text+="Поверка ПР ИЛ "+(i+1)+" выполнена - "+fmt(el.value)+" г.<br>";
        }
    });

    const pp = document.getElementById("verify-pp").value;

const ppInt = document.getElementById("verify-pp-int").value;
    if(pp){
        text+="Поверка ПП выполнена - "+fmt(pp)+" г. ("+ppInt+" г.)<br>";
    }

    const tpu = document.getElementById("verify-tpu").value;

const tpuInt = document.getElementById("verify-tpu-int").value;
    if(tpu){
        text+="Поверка ТПУ выполнена - "+fmt(tpu)+" г. ("+tpuInt+" г.)<br>";
    }

    const comp = document.getElementById("verify-comp").value;

const compInt = document.getElementById("verify-comp-int").value;



    if(comp){
        text+="Поверка компьютеров расхода выполнена - "+fmt(comp)+" г. ("+compInt+" г.)<br>";
    }



    if(activeVerifyCell){
        activeVerifyCell.innerHTML=text;checkVerifyColors(activeVerifyCell);
        checkVerifyColors(activeVerifyCell);
    }

fetch("/save_cell",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
        row: activeVerifyCell.parentElement.rowIndex,
        col: activeVerifyCell.cellIndex,
        value: text
    })
});

    document.getElementById("verify-popup").style.display="none";
};



document.getElementById("state-status").onchange=function(){

    const val=this.value;
    const block=document.getElementById("state-reason-block");
    const lbl=document.getElementById("state-date-label");

    if(val==="out"){
        block.style.display="block";
        lbl.innerText="Дата вывода:";
    }else{
        block.style.display="none";
        lbl.innerText="Дата ввода:";
    }
};

document.getElementById("state-cancel").onclick=function(){
    document.getElementById("state-popup").style.display="none";
};

document.getElementById("state-save").onclick=function(){

    function fmt(d){
        if(!d) return "";
        const p=d.split(".");
        return p[0]+"."+p[1]+"."+p[2];
    }

    const status=document.getElementById("state-status").value;
    const date=document.getElementById("state-date").value;
    const reason=document.getElementById("state-reason").value;
    const kmxDone=document.getElementById("state-kmx-done").value;
    const kmxPlan=document.getElementById("state-kmx-plan").value;

    let text="";

    if(status==="in"){
    text+="СИКН в учетных операциях с "+fmt(date)+" г.<br>";
}else{
    text+="СИКН выведена из учетных операций с "+fmt(date)+" г.<br>";
}

    if(kmxDone){
        text+="Последний КМХ проведен "+fmt(kmxDone)+" г.<br>";
    }

    if(kmxPlan){
        text+='<span style="color:red;">Планируемый срок КМХ - '+fmt(kmxPlan)+' г.</span>';
    }

    if(activeStateCell){
        activeStateCell.innerHTML=text;

const row = activeStateCell.parentElement;

if(status==="out"){
    row.classList.add("blue-row");
}else{
    row.classList.remove("blue-row");
}

fetch("/save_cell",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
        row: activeStateCell.parentElement.rowIndex,
        col: activeStateCell.cellIndex,
        value: text
    })
});
    }

    document.getElementById("state-popup").style.display="none";
};

document.getElementById("met-cancel").onclick=function(){
    document.getElementById("metrology-popup").style.display="none";
};

document.getElementById("met-save").onclick=function(){

    function fmt(d){
        if(!d) return "";
        const p=d.split(".");
        return p[0]+"."+p[1]+"."+p[2];
    }

    const cert=document.getElementById("met-cert").value;
    const reg=document.getElementById("met-reg").value;
    const date=document.getElementById("met-date").value;
    const expire=document.getElementById("met-expire").value;

    let text="";

    if(cert){
        text+="Сертификат о метрологической аттестации №"+cert+",<br>";
    }

    if(reg && date){
        text+="регистрационный номер в реестре ГСИ РК "+reg+" от "+fmt(date)+" г.<br>";
    }

    if(expire){
        text+="Срок действия МВИ СИКН – "+fmt(expire)+" г.";
    }

    if(activeMetCell){
        activeMetCell.innerHTML=text;

fetch("/save_cell",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
        row: activeMetCell.parentElement.rowIndex,
        col: activeMetCell.cellIndex,
        value: text
    })
});
    }

    document.getElementById("metrology-popup").style.display="none";
};



function checkVerifyColors(cell){

    if(!cell) return;

    // берем ЧИСТЫЙ текст без span
    let text = cell.innerText;

    const today = new Date();
    today.setHours(0,0,0,0);
    

    const regex = /(\d{2}\.\d{2}\.\d{4}) г\.\s*\((\d)\s*г\.\)/g;

    let newHTML = text.replace(/\n/g,"<br>");

    let match;

    while((match = regex.exec(text)) !== null){

        const dateStr = match[1];
        const years = parseInt(match[2]);

        const p = dateStr.split(".");
        let expire = new Date(p[2],p[1]-1,p[0]);

        expire.setFullYear(expire.getFullYear()+years);

        const diff = Math.floor((expire.getTime()-today.getTime())/86400000);

        if(diff < 0){
            newHTML = newHTML.replace(
                dateStr+" г.",
                '<span class="date-red">'+dateStr+' г.</span>'
            );
        }
        else if(diff <= 10){
            newHTML = newHTML.replace(
                dateStr+" г.",
                '<span class="date-orange">'+dateStr+' г.</span>'
            );
        }
    }

    cell.innerHTML = newHTML;
}


document.addEventListener("keydown", function(e){

// === ESC закрывает popup ===
if(e.key === "Escape"){

    if(document.getElementById("range-popup").style.display === "block"){
        document.getElementById("range-cancel").click();
    }

    if(document.getElementById("scheme-popup").style.display === "block"){
        document.getElementById("scheme-cancel").click();
    }

    if(document.getElementById("verify-popup").style.display === "block"){
        document.getElementById("verify-cancel").click();
    }

    if(document.getElementById("state-popup").style.display === "block"){
        document.getElementById("state-cancel").click();
    }

    if(document.getElementById("metrology-popup").style.display === "block"){
        document.getElementById("met-cancel").click();
    }

if(document.getElementById("range-after-popup").style.display === "block"){
    document.getElementById("after-cancel").click();
}


    return;
}

    if(e.key !== "Enter") return;

    // RANGE POPUP
    if(document.getElementById("range-popup").style.display === "block"){
        document.getElementById("range-save").click();
        return;
    }

    // SCHEME POPUP
    if(document.getElementById("scheme-popup").style.display === "block"){
        document.getElementById("scheme-save").click();
        return;
    }

    // VERIFY POPUP
    if(document.getElementById("verify-popup").style.display === "block"){
        document.getElementById("verify-save").click();
        return;
    }

// STATE POPUP
if(document.getElementById("state-popup").style.display === "block"){
    document.getElementById("state-save").click();
    return;
}

// METROLOGY POPUP
if(document.getElementById("metrology-popup").style.display === "block"){
    document.getElementById("met-save").click();
    return;
}

if(document.getElementById("range-after-popup").style.display === "block"){
    document.getElementById("after-save").click();
    return;
}



});

// ===== CLEAR CELL (ПКМ) =====
document.querySelectorAll("#sikn-table td").forEach(function(td){

    td.addEventListener("contextmenu", function(e){

        const col = td.cellIndex;

        // запрещаем очистку только служебных колонок 0-5
        if(col <= 5) return;

        e.preventDefault();

        if(!confirm("Удалить данные из ячейки?")) return;

        td.innerHTML="";

        const row = td.parentElement;

        // если очищаем состояние (12 колонка)
        if(col === 11){
            row.classList.remove("blue-row");
        }

        fetch("/save_cell",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                row: row.rowIndex,
                col: col,
                value: ""
            })
        });

    });

});

// ===== EXPORT TO EXCEL =====
document.getElementById("export-excel").onclick=function(){

    const table = document.getElementById("sikn-table").cloneNode(true);

    // === применяем стиль для Excel ===
    table.setAttribute("border","1");
    table.style.borderCollapse="collapse";

table.querySelectorAll("th,td").forEach(td=>{
    td.style.border="1px solid black";
    td.style.textAlign="center";
    td.style.verticalAlign="middle";
    td.style.fontFamily="Times New Roman";
});

table.querySelectorAll("th").forEach(th=>{
    th.style.fontSize="14pt";
    th.style.fontWeight="bold";
});

    // сохранить цвета строк
    table.querySelectorAll(".blue-row td").forEach(td=>{
        td.style.background="#4a7bd1";
        td.style.color="#ffffff";
    });

    // сохранить цвета дат
    table.querySelectorAll(".date-red").forEach(el=>{
        el.style.color="#ff0000";
        el.style.fontWeight="bold";
    });

    table.querySelectorAll(".date-orange").forEach(el=>{
        el.style.color="#ff7a00";
        el.style.fontWeight="bold";
    });

    let html = `
<html>
<head>
<meta charset="UTF-8">
<style>
body, table, th, td {
    font-family: "Times New Roman";
}
</style>
</head>

<body>


${table.outerHTML}

</html>
`;

    const blob = new Blob([html], { type: "application/vnd.ms-excel" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "SIKN_WEB.xls";
    a.click();
};

// ===== TOGGLE TECH COLUMNS =====

document.body.classList.add("hide-tech");

document.getElementById("toggle-tech-cols").onclick=function(){

    const body=document.body;
    const btn=this;

    body.classList.toggle("hide-tech");

    if(body.classList.contains("hide-tech")){
        btn.innerText="Показать тех. столбцы";
    }else{
        btn.innerText="Скрыть тех. столбцы";
    }

};

document.querySelectorAll(".custom-date").forEach(function(input){

    const wrapper = document.createElement("div");
    wrapper.style.position = "relative";

    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);

    input.style.paddingRight = "40px";

    const icon = document.createElement("span");
    icon.innerHTML = "📅";
    icon.style.position = "absolute";
    icon.style.right = "10px";
    icon.style.top = "50%";
    icon.style.transform = "translateY(-50%)";
    icon.style.cursor = "pointer";

    wrapper.appendChild(icon);

    const fp = flatpickr(input,{
        locale:"ru",
        dateFormat:"d.m.Y",
        allowInput:true,
        clickOpens:false,
        disableMobile:true
    });

    icon.addEventListener("click", function(){
        fp.open();
    });

});

document.getElementById("after-il-count").onchange=function(){

    const count = parseInt(this.value);
    const box = document.getElementById("after-il-container");
    box.innerHTML="";

    for(let i=1;i<=count;i++){
        const div=document.createElement("div");
        div.innerHTML='<label>Диапазон ИЛ '+i+':</label><input type="text" class="after-il">';
        box.appendChild(div);
    }
};

document.getElementById("after-cancel").onclick=function(){
    document.getElementById("range-after-popup").style.display="none";
};

document.getElementById("after-save").onclick=function(){

    const sikn = document.getElementById("after-sikn").value;
    const ils = document.querySelectorAll(".after-il");

    let text="";

    if(sikn){
        text+="Диапазон СИКН: "+sikn+"<br>";
    }

    ils.forEach((el,i)=>{
        if(el.value){
            text+="Диапазон ИЛ"+(i+1)+": "+el.value+"<br>";
        }
    });

    if(activeAfterCell){
        activeAfterCell.innerHTML=text;

        fetch("/save_cell",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                row: activeAfterCell.parentElement.rowIndex,
                col: activeAfterCell.cellIndex,
                value: text
            })
        });
    }

    document.getElementById("range-after-popup").style.display="none";
};

// ===== SCHEME COLUMN FIX =====
document.querySelectorAll("#sikn-table tr").forEach(function(row){

    const cells = row.querySelectorAll("td");

    if(cells.length < 10) return;

    const td = cells[9];

    td.style.cursor = "pointer";

    td.onclick = function(){

        activeSchemeCell = td;

        const select = document.getElementById("scheme-select");
        const current = td.innerText.trim();

        if(current){
            select.value = current;
        }else{
            select.selectedIndex = 0;
        }

        document.getElementById("scheme-popup").style.display = "block";
    };

});

// ===== STATE COLUMN (12) =====
document.querySelectorAll("#sikn-table tr").forEach(function(row,i){

    if(i===0) return;

    const td = row.querySelector("td:nth-child(12)");
    if(!td) return;

    td.style.cursor="pointer";

    td.onclick=function(){
        activeStateCell = td;
        document.getElementById("state-popup").style.display="block";
    };

});


// ===== METROLOGY COLUMN (13) =====
document.querySelectorAll("#sikn-table tr").forEach(function(row,i){

    if(i===0) return;

    const td = row.querySelector("td:nth-child(13)");
    if(!td) return;

    td.style.cursor="pointer";

    td.onclick=function(){
        activeMetCell = td;
        document.getElementById("metrology-popup").style.display="block";
    };

});

// ===== LOGIN LOGIC =====

function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if(parts.length === 2) return parts.pop().split(';').shift();
}

// если уже авторизован — скрываем логин
const user = getCookie("user");
const userDivision = getCookie("division");

if(user){
    document.getElementById("login-block").style.display="none";

    if(userDivision === "east"){
        document.querySelectorAll("#sikn-table tr[data-row]").forEach(row=>{
            const r = parseInt(row.getAttribute("data-row"));
            if(r >= 1 && r <= 48){
                row.style.display = "none";
            }
        });
    }

    if(userDivision === "west"){
        document.querySelectorAll("#sikn-table tr[data-row]").forEach(row=>{
            const r = parseInt(row.getAttribute("data-row"));
            if(r >= 49 && r <= 59){
                row.style.display = "none";
            }
        });
    }
}




        

// функция входа
function doLogin(){

    const username=document.getElementById("login-username").value;
    const password=document.getElementById("login-password").value;

    fetch("/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password})
    })
    .then(r=>r.json())
    .then(data=>{

        if(data.ok){
            location.reload();
        }else{
            document.getElementById("login-error").innerText="Неверный логин или пароль";
        }

    });
}

// кнопка
document.getElementById("login-btn").onclick = doLogin;

document.getElementById("logout-btn").onclick = function(){

    fetch("/logout",{ method:"POST" })
    .then(()=>{

        document.cookie = "user=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.cookie = "division=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

        location.reload();
    });

};

// Enter в поле пароля
document.getElementById("login-password").addEventListener("keydown", function(e){
    if(e.key === "Enter"){
        doLogin();
    }
});

</script>



</body>
</html>